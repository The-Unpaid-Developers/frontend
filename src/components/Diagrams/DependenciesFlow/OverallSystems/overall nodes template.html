<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Overall Systems</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        color: #111827;
      }
      .controls-container {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .graph-container {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        overflow: hidden;
      }
      svg {
        width: 100%;
        height: 100%;
      }
      .node circle {
        stroke: #fff;
        stroke-width: 2px;
        transition: transform 0.2s ease-in-out, stroke 0.2s;
      }
      .node:hover circle {
        transform: scale(1.2);
      }
      .node text {
        font-size: 10px;
        pointer-events: none;
        fill: #374151;
        font-weight: 500;
      }
      .link {
        stroke-opacity: 0.6;
        transition: stroke-opacity 0.3s, stroke 0.3s, stroke-width 0.3s;
      }
      .link-label {
        font-size: 9px;
        fill: #4b5563;
        pointer-events: none;
        text-anchor: middle;
      }
      .tooltip {
        position: absolute;
        text-align: left;
        padding: 8px;
        font-size: 12px;
        background: #1f2937;
        color: #fff;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
      }
      .highlighted {
        stroke: #ef4444;
        stroke-width: 3px !important;
        stroke-opacity: 1;
      }
      .path-highlight-node circle {
        stroke: #10b981;
        stroke-width: 4px;
      }
      .path-highlight-link {
        stroke: #10b981;
        stroke-width: 4px;
        stroke-opacity: 1;
      }
      .dimmed {
        opacity: 0.1;
      }
      .select-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: #fff;
        box-shadow: inset 0 1px 2px 0 rgb(0 0 0 / 0.05);
      }
    </style>
  </head>
  <body class="p-4 lg:p-6">
    <div class="max-w-screen-2xl mx-auto">
      <header class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
          Overall Systems
        </h1>
        <p class="text-gray-600 mt-1">
          Generated on: <span id="generated-date"></span>
        </p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Controls Column -->
        <div class="lg:col-span-3 controls-container p-5 self-start">
          <h2 class="text-xl font-semibold mb-4 border-b pb-2">Filters</h2>

          <div class="space-y-6">
            <!-- General Filters -->
            <div>
              <div class="space-y-4">
                <div>
                  <label
                    for="system-search"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    >Filter by System Name/Code</label
                  >
                  <input
                    type="text"
                    id="system-search"
                    class="select-input"
                  />
                </div>
                <div>
                  <label
                    for="system-type-filter"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    >System Type</label
                  >
                  <select id="system-type-filter" class="select-input"></select>
                </div>
                <div hidden>
                  <label
                    for="connection-type-filter"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    >Connection Type</label
                  >
                  <select
                    id="connection-type-filter"
                    class="select-input"
                  ></select>
                </div>
                <div>
                  <label
                    for="criticality-filter"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    >Criticality</label
                  >
                  <select id="criticality-filter" class="select-input"></select>
                </div>
                <div hidden>
                  <label
                    for="frequency-filter"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    >Frequency</label
                  >
                  <select id="frequency-filter" class="select-input"></select>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="border-t pt-4 flex space-x-2">
              <button
                id="apply-filters-button"
                class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
              >
                Apply Filters
              </button>
              <button
                id="reset-button"
                class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Reset All
              </button>
            </div>
            <div class="mt-8 border-t pt-4">
                    <h3 class="text-lg font-semibold mb-2">Nodes Legend (Criticality)</h3>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #ef4444;"></div>
                            <span class="text-sm">Major</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #f59e0b;"></div>
                            <span class="text-sm">Standard-1</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #22c55e;"></div>
                            <span class="text-sm">Standard-2</span>
                        </div>
                         <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #6b7280;"></div>
                            <span class="text-sm">N/A or Other</span>
                        </div>
                    </div>
          </div>
          </div>
        </div>

        <!-- Graph Column -->
        <div class="lg:col-span-9 graph-container h-[85vh]">
          <div id="graph-wrapper" class="w-full h-full relative">
            <!-- SVG for D3 will be appended here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script type="module">
      // --- DEFAULT DATA ---
      const defaultData = {};

      // --- GLOBAL VARIABLES ---
      let originalNodes, originalLinks;
      let simulation, svg, g, link, node, linkLabel;
      const tooltip = d3.select("#tooltip");
      const nodesColorScale = d3.scaleOrdinal()
            .domain(["Major", "Standard-1", "Standard-2", "Standard-3"])
            .range(["#ef4444", "#f59e0b", "#22c55e", "#0ea5e9"])
            .unknown("#6b7280");

      // --- DOM ELEMENTS ---
      const wrapper = d3.select("#graph-wrapper");
      const systemSearchInput = document.getElementById("system-search");
      const systemTypeFilter = document.getElementById("system-type-filter");
      const connectionTypeFilter = document.getElementById(
        "connection-type-filter"
      );
      const criticalityFilter = document.getElementById("criticality-filter");
      const frequencyFilter = document.getElementById("frequency-filter");
      const applyFiltersButton = document.getElementById(
        "apply-filters-button"
      );
      const resetButton = document.getElementById("reset-button");

      const generatedDate = defaultData.metadata.generatedDate;
      document.getElementById("generated-date").innerHTML = generatedDate;

      // --- INITIALIZATION ---
      function initialize(defaultData) {
        originalNodes = JSON.parse(JSON.stringify(defaultData.nodes));
        originalLinks = JSON.parse(JSON.stringify(defaultData.links));

        populateFilters();
        setupEventListeners();
        updateGraph(originalNodes, originalLinks);
      }

      // --- GRAPH CREATION & UPDATE ---
      function updateGraph(nodes, links) {
        wrapper.selectAll("*").remove();

        const { width, height } = wrapper.node().getBoundingClientRect();

        svg = wrapper
          .append("svg")
          .attr("viewBox", [0, 0, width, height])
          .call(
            d3
              .zoom()
              .on("zoom", (event) => g.attr("transform", event.transform))
          );

        g = svg.append("g");

        svg
          .append("defs")
          .selectAll("marker")
          .data(["end"])
          .join("marker")
          .attr("id", String)
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 30)
          .attr("refY", 0)
          .attr("markerWidth", 6)
          .attr("markerHeight", 6)
          .attr("orient", "auto")
          .append("path")
          .attr("d", "M0,-5L10,0L0,5")
          .attr("fill", "#999");

        function forceCluster() {
          const strength = 0.3;
          let nodes;

          function force(alpha) {
            const centroids = d3.rollup(nodes, centroid, d => d.type);

            function centroid(nodes) {
              let x = 0;
              let y = 0;
              for (const d of nodes) {
                x += d.x;
                y += d.y;
              }
              return {x: x / nodes.length, y: y / nodes.length};
            }
            for (const d of nodes) {
              const center = centroids.get(d.type);
              d.vx -= (d.x - center.x) * alpha * strength;
              d.vy -= (d.y - center.y) * alpha * strength;
            }
          }
          force.initialize = _ => nodes = _;
          return force;
        }

        simulation = d3
          .forceSimulation(nodes)
          .force(
            "link",
            d3
              .forceLink(links)
              .id((d) => d.id)
              .distance(150)
          )
          .force("charge", d3.forceManyBody().strength(-200))
          .force("center", d3.forceCenter(width / 2, height / 2))
          // .force("cluster", forceCluster())
          .on("tick", ticked);

        link = g
          .append("g")
          .selectAll("line")
          .data(links)
          .join("line")
          .attr("class", "link")
          .attr("stroke", "#999")
          // .attr("marker-end", "url(#end)")
          .on("mouseover", handleLinkMouseOver)
          .on("mouseout", handleLinkMouseOut);

        node = g
          .append("g")
          .selectAll("g")
          .data(nodes)
          .join("g")
          .attr("class", "node")
          .call(drag(simulation))
          .on("mouseover", handleNodeMouseOver)
          .on("mouseout", handleNodeMouseOut)
          .on("click", (event, d) => {
            if (d.url) {
              window.open(d.url, "_blank");
            }
          });

        node
          .append("circle")
          .attr("r", 12)
          .attr("fill", (d) => nodesColorScale(d.criticality));

        node
          .append("text")
          .text((d) => d.name)
          .attr("dx", 15)
          .attr("dy", "0.35em");

        linkLabel = g
          .append("g")
          .selectAll("text")
          .data(links)
          .join("text")
          .attr("class", "link-label")
          .text((d) => d.pattern);

        function ticked() {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("transform", (d) => `translate(${d.x},${d.y})`);

          linkLabel
            .attr("x", (d) => (d.source.x + d.target.x) / 2)
            .attr("y", (d) => (d.source.y + d.target.y) / 2);
        }
      }

      // --- INTERACTIVITY & EVENT HANDLERS ---
      function drag(sim) {
        function dragstarted(event, d) {
          if (!event.active) sim.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }
        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }
        // function dragended(event, d) {
        //   if (!event.active) sim.alphaTarget(0);
        //   d.fx = null;
        //   d.fy = null;
        // }
        return d3
          .drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          // .on("end", dragended);
      }

      function handleNodeMouseOver(event, d) {
        tooltip.transition().duration(200).style("opacity", 0.9);
        tooltip
          .html(
            `<strong>${d.name} (${d.id})</strong><br/>Type: ${d.type}<br/>Criticality: ${d.criticality}`
          )
          .style("left", event.pageX + 15 + "px")
          .style("top", event.pageY - 28 + "px");
      }

      function handleNodeMouseOut() {
        tooltip.transition().duration(500).style("opacity", 0);
      }

      function handleLinkMouseOver(event, d) {
        tooltip.transition().duration(200).style("opacity", 0.9);
        tooltip
          .html(
            `<strong>Connection</strong><br/>From: ${d.source.id} To: ${
              d.target.id
            }<br/>Pattern: ${d.pattern}<br/>Frequency: ${
              d.frequency
            }<br/>Desc: ${d.description || "N/A"}`
          )
          .style("left", event.pageX + 15 + "px")
          .style("top", event.pageY - 28 + "px");
        d3.select(this).classed("highlighted", true);
      }

      function handleLinkMouseOut() {
        tooltip.transition().duration(500).style("opacity", 0);
        d3.select(this).classed("highlighted", false);
      }

      function setupEventListeners() {
        resetButton.addEventListener("click", resetAll);
        applyFiltersButton.addEventListener("click", applyFilters);
      }

      // --- CHANGED START: Rewritten filter logic ---
        function applyFilters() {
            clearHighlightsAndSelections();
            const searchTerm = systemSearchInput.value.toLowerCase();
            const selectedType = systemTypeFilter.value;
            const selectedConnection = connectionTypeFilter.value;
            const selectedCriticality = criticalityFilter.value;
            const selectedFrequency = frequencyFilter.value;
            // const pinnedSystemId = "WBIS";

            // 1. Filter nodes based on node-specific criteria. These are our "focus" nodes.
            const focusNodes = originalNodes.filter(n => {
                // const nameMatch = searchTerm === '' || n.name.toLowerCase().includes(searchTerm) || n.code.toLowerCase().includes(searchTerm);
                const typeMatch = selectedType === 'All' || n.type === selectedType;
                const criticalityMatch = selectedCriticality === 'All' || n.criticality === selectedCriticality;
                return typeMatch && criticalityMatch;  
            });
            const focusNodeIds = new Set(focusNodes.map(n => n.id));
            
            console.log('filtered nodes ', focusNodeIds);

            // 2. Filter links based on link-specific criteria.
            const linkFilteredLinks = originalLinks.filter(l => {
                const connectionMatch = selectedConnection === 'All' || l.pattern === selectedConnection;
                const frequencyMatch = selectedFrequency === 'All' || l.frequency === selectedFrequency;
                return connectionMatch && frequencyMatch;
            });

            console.log('filtered links ', linkFilteredLinks);
            // 3. The final links are the ones from linkFilteredLinks that touch at least one of the focusNodes.
            let finalLinks = "";
            if (searchTerm !== '') {
              finalLinks = linkFilteredLinks.filter(l =>
                (focusNodeIds.has(l.source.id) && l.target.id.toLowerCase().includes(searchTerm)) || (focusNodeIds.has(l.target.id) && l.source.id.toLowerCase().includes(searchTerm))
            );
            } else {
              finalLinks = linkFilteredLinks.filter(l =>
                (focusNodeIds.has(l.source.id)) && (focusNodeIds.has(l.target.id))
            );
            }
            console.log('finalLinks: ', finalLinks);

            // 4. The final set of nodes includes all nodes from the final links, plus any focus nodes that might be isolates.
            const finalNodeIds = new Set();
            finalLinks.forEach(l => {
                finalNodeIds.add(l.source.id);
                finalNodeIds.add(l.target.id);
            });
            if (searchTerm === '') {
              focusNodeIds.forEach(id => finalNodeIds.add(id)); // Add back isolates that match filters
            }

            const finalNodes = originalNodes.filter(n => finalNodeIds.has(n.id));

            updateGraph(finalNodes, finalLinks);
        }
        // --- CHANGED END ---

      // --- UTILITY FUNCTIONS ---
      function populateFilters() {
        const systemTypes = [
          "All",
          ...new Set(originalNodes.map((d) => d.type)),
        ];
        const connectionTypes = [
          "All",
          ...new Set(originalLinks.map((d) => d.pattern)),
        ];
        const criticalities = [
          "All",
          ...new Set(originalNodes.map((d) => d.criticality)),
        ];
        const frequencies = [
          "All",
          ...new Set(originalLinks.map((d) => d.frequency)),
        ];
        const systemOptions = [
          "None",
          ...originalNodes.map((d) => d.id),
        ].sort();

        populateSelect(systemTypeFilter, systemTypes);
        populateSelect(connectionTypeFilter, connectionTypes);
        populateSelect(criticalityFilter, criticalities);
        populateSelect(frequencyFilter, frequencies);
      }

      function populateSelect(selectElement, options) {
        selectElement.innerHTML = "";
        options.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          selectElement.appendChild(option);
        });
      }

      function clearHighlightsAndSelections() {
            if (node) node.classed('dimmed', false).classed('path-highlight-node', false);
            if (link) link.classed('dimmed', false).classed('path-highlight-link', false);
        }


      function resetAll() {
        // Reset all filter inputs to their default state
        systemSearchInput.value = "";
        systemTypeFilter.value = "All";
        connectionTypeFilter.value = "All";
        criticalityFilter.value = "All";
        frequencyFilter.value = "All";

        clearHighlightsAndSelections();
        updateGraph(originalNodes, originalLinks);
      }

      // --- START THE APP ---
      initialize(defaultData);
    </script>
  </body>
</html>
